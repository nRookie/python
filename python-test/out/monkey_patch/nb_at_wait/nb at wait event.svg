<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="300px" preserveAspectRatio="none" style="width:1095px;height:300px;" version="1.1" viewBox="0 0 1095 300" width="1095px" zoomAndPan="magnify"><defs><filter height="300%" id="f1asj2kpmhxv0v" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#f1asj2kpmhxv0v)" height="82.7031" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="167.5" y="119.9609"/><rect fill="#FFFFFF" filter="url(#f1asj2kpmhxv0v)" height="52.3516" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="649.5" y="150.3125"/><rect fill="#FFFFFF" filter="url(#f1asj2kpmhxv0v)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="654.5" y="188.6641"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="27" x2="27" y1="87.6094" y2="211.6641"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="172" x2="172" y1="87.6094" y2="211.6641"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="300" x2="300" y1="87.6094" y2="211.6641"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="394" x2="394" y1="87.6094" y2="211.6641"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="464" x2="464" y1="87.6094" y2="211.6641"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="545" x2="545" y1="87.6094" y2="211.6641"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="654" x2="654" y1="87.6094" y2="211.6641"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="801.5" x2="801.5" y1="87.6094" y2="211.6641"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="907.5" x2="907.5" y1="87.6094" y2="211.6641"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="982.5" x2="982.5" y1="87.6094" y2="211.6641"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1056.5" x2="1056.5" y1="87.6094" y2="211.6641"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="33" x="8" y="84.5332">robot</text><ellipse cx="27.5" cy="13" fill="#FEFECE" filter="url(#f1asj2kpmhxv0v)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M27.5,21 L27.5,48 M14.5,29 L40.5,29 M27.5,48 L14.5,63 M27.5,48 L40.5,63 " fill="none" filter="url(#f1asj2kpmhxv0v)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="33" x="8" y="225.1973">robot</text><ellipse cx="27.5" cy="238.2734" fill="#FEFECE" filter="url(#f1asj2kpmhxv0v)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M27.5,246.2734 L27.5,273.2734 M14.5,254.2734 L40.5,254.2734 M27.5,273.2734 L14.5,288.2734 M27.5,273.2734 L40.5,288.2734 " fill="none" filter="url(#f1asj2kpmhxv0v)" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#f1asj2kpmhxv0v)" height="31.6094" style="stroke: #A80036; stroke-width: 1.5;" width="119" x="111" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="105" x="118" y="72.5332">NB_ATKeywords</text><rect fill="#FEFECE" filter="url(#f1asj2kpmhxv0v)" height="31.6094" style="stroke: #A80036; stroke-width: 1.5;" width="119" x="111" y="210.6641"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="105" x="118" y="232.1973">NB_ATKeywords</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="107" x="244" y="84.5332">response_queue</text><ellipse cx="300.5" cy="54" fill="#FEFECE" filter="url(#f1asj2kpmhxv0v)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="288.5" x2="312.5" y1="68" y2="68"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="107" x="244" y="225.1973">response_queue</text><ellipse cx="300.5" cy="244.2734" fill="#FEFECE" filter="url(#f1asj2kpmhxv0v)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="288.5" x2="312.5" y1="258.2734" y2="258.2734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="367" y="84.5332">rxBuffer</text><ellipse cx="394.5" cy="54" fill="#FEFECE" filter="url(#f1asj2kpmhxv0v)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="382.5" x2="406.5" y1="68" y2="68"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="367" y="225.1973">rxBuffer</text><ellipse cx="394.5" cy="244.2734" fill="#FEFECE" filter="url(#f1asj2kpmhxv0v)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="382.5" x2="406.5" y1="258.2734" y2="258.2734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="58" x="432" y="84.5332">rspBuffer</text><ellipse cx="464" cy="54" fill="#FEFECE" filter="url(#f1asj2kpmhxv0v)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="452" x2="476" y1="68" y2="68"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="58" x="432" y="225.1973">rspBuffer</text><ellipse cx="464" cy="244.2734" fill="#FEFECE" filter="url(#f1asj2kpmhxv0v)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="452" x2="476" y1="258.2734" y2="258.2734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="73" x="506" y="84.5332">eventBuffer</text><ellipse cx="545.5" cy="54" fill="#FEFECE" filter="url(#f1asj2kpmhxv0v)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="533.5" x2="557.5" y1="68" y2="68"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="73" x="506" y="225.1973">eventBuffer</text><ellipse cx="545.5" cy="244.2734" fill="#FEFECE" filter="url(#f1asj2kpmhxv0v)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="533.5" x2="557.5" y1="258.2734" y2="258.2734"/><rect fill="#FEFECE" filter="url(#f1asj2kpmhxv0v)" height="31.6094" style="stroke: #A80036; stroke-width: 1.5;" width="115" x="595" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="101" x="602" y="72.5332">low_level_nb_at</text><rect fill="#FEFECE" filter="url(#f1asj2kpmhxv0v)" height="31.6094" style="stroke: #A80036; stroke-width: 1.5;" width="115" x="595" y="210.6641"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="101" x="602" y="232.1973">low_level_nb_at</text><rect fill="#FEFECE" filter="url(#f1asj2kpmhxv0v)" height="31.6094" style="stroke: #A80036; stroke-width: 1.5;" width="124" x="737.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="110" x="744.5" y="72.5332">low_level_uart_at</text><rect fill="#FEFECE" filter="url(#f1asj2kpmhxv0v)" height="31.6094" style="stroke: #A80036; stroke-width: 1.5;" width="124" x="737.5" y="210.6641"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="110" x="744.5" y="232.1973">low_level_uart_at</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="59" x="875.5" y="84.5332">rx_queue</text><ellipse cx="908" cy="54" fill="#FEFECE" filter="url(#f1asj2kpmhxv0v)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="896" x2="920" y1="68" y2="68"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="59" x="875.5" y="225.1973">rx_queue</text><ellipse cx="908" cy="244.2734" fill="#FEFECE" filter="url(#f1asj2kpmhxv0v)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="896" x2="920" y1="258.2734" y2="258.2734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="58" x="950.5" y="84.5332">tx_queue</text><ellipse cx="982.5" cy="54" fill="#FEFECE" filter="url(#f1asj2kpmhxv0v)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="970.5" x2="994.5" y1="68" y2="68"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="58" x="950.5" y="225.1973">tx_queue</text><ellipse cx="982.5" cy="244.2734" fill="#FEFECE" filter="url(#f1asj2kpmhxv0v)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="970.5" x2="994.5" y1="258.2734" y2="258.2734"/><rect fill="#FEFECE" filter="url(#f1asj2kpmhxv0v)" height="31.6094" style="stroke: #A80036; stroke-width: 1.5;" width="60" x="1024.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="46" x="1031.5" y="72.5332">module</text><rect fill="#FEFECE" filter="url(#f1asj2kpmhxv0v)" height="31.6094" style="stroke: #A80036; stroke-width: 1.5;" width="60" x="1024.5" y="210.6641"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="46" x="1031.5" y="232.1973">module</text><rect fill="#FFFFFF" filter="url(#f1asj2kpmhxv0v)" height="82.7031" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="167.5" y="119.9609"/><rect fill="#FFFFFF" filter="url(#f1asj2kpmhxv0v)" height="52.3516" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="649.5" y="150.3125"/><rect fill="#FFFFFF" filter="url(#f1asj2kpmhxv0v)" height="14" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="654.5" y="188.6641"/><polygon fill="#A80036" points="155.5,115.9609,165.5,119.9609,155.5,123.9609,159.5,119.9609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="27.5" x2="161.5" y1="119.9609" y2="119.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="34.5" y="115.1045">NB AT WAIT EVENT</text><polygon fill="#A80036" points="637.5,146.3125,647.5,150.3125,637.5,154.3125,641.5,150.3125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="177.5" x2="643.5" y1="150.3125" y2="150.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="184.5" y="145.4561">uart_wait_event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="659.5" x2="706.5" y1="175.6641" y2="175.6641"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="706.5" x2="706.5" y1="175.6641" y2="188.6641"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="665.5" x2="706.5" y1="188.6641" y2="188.6641"/><polygon fill="#A80036" points="675.5,184.6641,665.5,188.6641,675.5,192.6641,671.5,188.6641" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="671.5" y="170.8076">_parse_event_string()</text><!--MD5=[3d8526e5201ee36cb164e72b3efe6ab0]
@startuml nb at wait event 

actor robot as r

participant NB_ATKeywords as na


entity response_queue as rspq

entity rxBuffer as rxb
entity rspBuffer as rspb
entity eventBuffer as eb

participant low_level_nb_at as llna

participant low_level_uart_at as llua  

entity rx_queue as rxq
entity tx_queue as txq

participant module as m

/'
loop when uart port is opened 
    alt uart_write is set
        txq -> m: send data
        llua -> llua: unset uart_write
    else uart_write is not set and there is data from module 
        m -> rxq: recv data 
    end
end 

loop when uart port is opened
    llna -> llua: ll_uart_read
    llna -> rxq: get data from rx_queue 
    rxq -> llna: return data

    alt wait_response_counter > 0

        loop length of data > 0
            llna -> rspb: put one bytes of data into rspBuffer and len of data - 1.
            rspb -> llna: decode the data from rspBuffer into recv
        
            alt  recv ends with expected_endswith_str
                llna -> rspq: put the recv into response_queue
                llna -> llna: wait rsp_counter decrase
                alt length of data != 0
                    llna -> eb: put the remaining data into event_buffer.
                end
                llna -> rspb: clear the content in the rspBuffer
                llna -> llna: clear the expected_endswith_str
            else parse recv according to RESPONSE_REGEXP

                alt recv match the RESPONSE_REGEXP 
                    llna -> rspq: put the recv into response_queue.
                    llna -> llna: wait rsp_counter decrase

                    alt length of data != 0
                    llna -> eb: put the remaining data into event_buffer.
                    end

                    llna -> rspb: clear the content in the rspBuffer
                end 

            end 
        end
    
    else wait_response_counter == 0
        llna -> eb: put data into the event_Buffer
    end
end

r -> na : NB AT EXE CMD
activate na
    na -> na : NB AT SEND CMD
    activate na
        na -> na: NB AT SEND DATA
        activate na
            na -> llna: uart write
            activate llna
                llna -> llua: ll uart write
                activate llua
                    llua -> txq: enqueue
                    llua -> llua: set uart_write
                    llua -> llna:
                    deactivate llua
                llna -> na:  
                deactivate llna
            deactivate na
        na -> llna: wait rsp_counter increase
        llna -> na:
        deactivate na
    na -> na: NB AT READ CMD RSP
    activate na
        alt enswith_str is not None 
            na -> na: set expected_rsp_endswith to endwith_str
        end
        na -> llna: uart_read
        activate llna
            alt  remain_time >0 and response_queue is not empty
                llna -> rspq: get data from response queue
                rspq -> llna : return some data
                llna -> na: return data 
            else remain_time < 0
                llna -> llna: wait rsp_counter decrease
                llna -> na: raise Timeout Error
            end
            deactivate llna
        na -> na: return data
        deactivate na
    na -> r : return data
    deactivate na
'/
r -> na: NB AT WAIT EVENT
activate na
    na -> llna: uart_wait_event
    activate llna
        llna -> llna: _parse_event_string()
        activate llna

@enduml

@startuml nb at wait event 

actor robot as r

participant NB_ATKeywords as na


entity response_queue as rspq

entity rxBuffer as rxb
entity rspBuffer as rspb
entity eventBuffer as eb

participant low_level_nb_at as llna

participant low_level_uart_at as llua  

entity rx_queue as rxq
entity tx_queue as txq

participant module as m

r -> na: NB AT WAIT EVENT
activate na
    na -> llna: uart_wait_event
    activate llna
        llna -> llna: _parse_event_string()
        activate llna

@enduml

PlantUML version 1.2020.10(Sun May 17 17:35:57 CST 2020)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) Client VM
Java Version: 1.8.0_221-b11
Operating System: Windows 10
Default Encoding: MS932
Language: zh
Country: CN
--></g></svg>